# WebP 프로젝트 트러블 슈팅

회사에서 진행중인 프로젝트가 있다. 데이블 위젯 썸네일은 현재 jpeg 확장자로 노출되고 있는데, 트래픽 비용을 절감하기 위해서 해당 썸네일을 모두 webp 확장자로 바꾸는 작업이다. 이게 생각보다 간단한 것 같지만, 데이블 위젯 코드가 굉장히 복잡하고, 디버깅도 쉽지 않아서 여러 어려움을 겪었다. 그 중 꽤나 나를 괴롭혔던 문제와 해당 문제를 해결했던 것을 기록하고자 여기에 남긴다.   

(회사 내부적인 내용은 노출하면 안되기에 중간중간 상세한 설명 없이 넘어갈 수도 있을 것 같다. 또한 변수명, 함수명 등은 실제 코드와 다를 수 있다.)

<br>

## 프론트에 처리해야 하는 방식

- 썸네일 렌더링을 위해 기존 `jpeg` 링크가 담긴 객체에 확장자만 `webp` 로 바꿔서 한 벌 더 저장(썸네일서버에 `webp` 가 모두 있다고 가정했기 때문)
- `webp` 를 먼저 노출하고 `webp` 를 지원하지 않는 곳에는 `jpeg` 가 노출되도록 `picture` 태그로 처리

<br>

## 1차 문제 발생

- `webp`를 지원하는 브라우저인데, `webp` 확장자의 이미지가 없는 경우가 존재한다(`403 에러`). 이 때 `jpeg`가 보여지는게 **아닌 깨진 `webp`** 이미지가 렌더링 된다.
  > ***해결)**   
  `picture` 태그 내부 `img` 태그에 `onerror` 속성을 줘서 `webp` 이미지가 로드되지 않을 경우, `jpeg`가 보여지도록 했다(일반 웹에서도 테스트 해봤는데 잘 렌더링되는 것을 확인했다. 위젯에서도 잘 될 거라고 생각했다)*

<br>

## 2차 문제 발생

- 위젯에서 기본적으로 `img` 태그가 로드되지 않으면 `handleImageError` 함수가 동작하도록 되어 있다. 해당 함수 로직은 이미지가 로드되지 않으면, 여분의 다른 콘텐츠를 노출 시키기 위한 작업을 하는 함수이다.
- 문제는, 1차 문제에서 해결했던 **`webp` 이미지가 없을 때 `jpeg` 이미지가 노출**이 되기 전에 대부분 **`handleImageError`가 동작**하고 콘텐츠를 버린다.
- 버리고 다시 갈아 끼운 콘텐츠에 `webp` 이미지가 있으면 그대로 콘텐츠를 노출하고, 없으면 또 버리는 형식으로 진행된다.

<br>

## 고민해본 해결 방법

1. 에러가 발생해서 `handleImageError`가 동작되면 해당 함수 안에서 `webp`를 `jpeg` 확장자로 바꾸는 로직을 넣은 다음, 다시 체크하고 `jpeg`가 잘 노출되면 해당 함수를 종료한다.
   - 시도해보지는 않았지만 뭔가 우아한 방법은 아닌 것 같고, 예상되는 부수효과가 있을 수도 있을 것 같다.
2. `picture` 대신에 `img` 태그를 쓰되 `img` 태그가 렌더링 되는 파일에서 분기처리를 해준다.
   - 이것도 시도해보진 않았고, 프로젝트 초기 기획에서 가고자 했던 'picture 태그를 사용한다'와 다른 방향이라서 고민이 필요하다.
3. 렌더링 되기 전에 `webp`가 실제로 존재하는지 서버 요청을 통해 확인한다.
   - 모든 이미지마다 API 요청을 해야해서 좋은 방향은 아닌 것 같다.
4. 썸네일서버에서 `webp` 확장자도 `jpeg`와 함께 잘 있게끔(?) 한다.
   - 개인적으로는 이 방법이 제일 깔끔한 것 같다. 프론트에서도 크게 고치지 않고 보여주기만 하면 되기 때문에 괜찮지 않을까 생각한다.
      > ***답변)**   
      어떻게 구성할지 고민을 좀 해봐야할 것 같다. 하지만 프로늩에서도 `webp`가 없을 때 대응하는 작업은 불가피해 보인다.*

<br>

## 결론

- 몰랐던 부분
  - 위젯에 콘텐츠가 렌더링 되기 전에 여분의 콘텐츠 모두 준비되어 있다는 사실을 몰랐다.
    - 즉, 내가 착각했던 부분은
      - 콘솔창에 제일 처음으로 `webp` 이미지가 없다는 에러가 발생했을 때, 해당 썸네일 이미지를 바로 `jpeg`로 바꾼 다음 보여줘야 하는 게 아닌가 생각했다. 하지만 그게 아니라 세번째 에러가 발생한 썸네일 이미지가 `jpeg`으로 바뀌는 등 순서와 상관 없이 `webp`가 없는 콘텐츠가 있으면 그 콘텐츠를 `jpeg`로 바꾸고 보여주는 것이었다.
    - ❗**하지만 그게 아니었다.**
      - 처음 콘솔창에 에러가 찍혔다고 해서 걔가 처음 위젯에 그려지는 게 아니였던 것이다.
        일단 준비된 위젯을 모두 렌더링한 다음 뽑아서 위젯에 그려주는 것이었다.
        **그렇다면 `webp`가 없는 콘텐츠들은 콘솔창에 무조건 에러가 뜨는 것..!**

- 해결한 부분
    - 내가 애초에 가정한 잘못되었다고 생각한 부분은 잘못된 게 아니라 자연스러웠던 것이다.
    - 하지만 `picture` 태그에 `img`에 `onerror` 속성을 달아서 핸들링하는 건 적절하지 않아 보인다.
      - 위젯에 그려주지 않을, 즉 보여줄 필요 없는 이미지를 굳이 `jpeg`으로 한번 더 요청할 필요가 없기 때문이다(상세한 내용은 생략).
      - 그래서 직접 에러 핸들링을 하는 로직에 추가적인 로직을 적용하여 해결했다.

- 깨달은 점
  - 문제를 발견했을 때 '내가 이럴 것이다' 라고 가정하고 그 가정을 토대로 해결하려고 하지 말고, 그 앞단에서 뭔가 내가 놓친 것은 없는지, 제대로 맥락을 파악하고 있는지 한번 더 점검한 뒤에 문제를 가정하고 해결하자고 생각했다.
